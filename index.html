
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Gift Mini App</title>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>

  <link rel="stylesheet" href="style.css">
</head>
<body>

<!-- HOME -->
<div id="home" class="page active">
  <div class="top">
    <div class="userBar">
      <img id="avatar" class="avatar">
      <span id="balance">0.00 TON</span>
    </div>
  </div>

  <div class="caseBlock">
    <div class="caseIcon"></div>
    <div class="caseTitle">Daily Case</div>
    <button id="openDaily" class="caseBtn">Открыть кейс</button>
  </div>
</div>

<!-- PROFILE -->
<div id="profile" class="page">
  <div class="top">
    <div class="userBar">
      <img id="profileAvatar" class="avatar big">
      <span id="balanceProfile">0.00 TON</span>
    </div>
  </div>

  <div id="username"></div>

  <button id="connectWallet">Подключить кошелёк</button>
  <button id="disconnectWallet" style="display:none">Отключить кошелёк</button>
  <button id="deposit">Пополнить баланс</button>
  <button id="openInventory">Инвентарь</button>
</div>

<!-- SUBSCRIBE MODAL -->
<div id="subscribeModal" class="modal">
  <div class="subscribeContent">
    <div class="subscribeText">Для открытия кейса нужно подписаться на канал</div>
    <button id="subscribeBtn" class="caseBtn">Подписаться</button>
  </div>
</div>

<!-- CASE MODAL -->
<div id="caseModal" class="modal">
  <div class="caseModalContent">
    <div class="caseHeader">
      <div class="caseTitle">Daily Case</div>
      <button id="closeCase" class="closeBtn">✕</button>
    </div>

    <div class="stripWrap">
      <div id="strip" class="strip"></div>
      <div class="pointer"></div>
    </div>

    <div id="resultText" class="resultText">Нажми "Открыть кейс"</div>
    <button id="openCaseBtn" class="caseBtn">Открыть кейс</button>
  </div>
</div>

<!-- INVENTORY MODAL -->
<div id="inventoryModal" class="modal">
  <div class="inventoryContent">
    <button id="closeInventory" class="closeBtn">✕</button>
    <div id="inventoryList" class="inventoryList"></div>
  </div>
</div>

<div class="nav">
  <button id="btnHome">Главная</button>
  <button id="btnProfile">Профиль</button>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {

  if (!window.Telegram || !window.Telegram.WebApp) {
    alert("Mini App должен запускаться через Telegram!");
    return;
  }

  const tg = window.Telegram.WebApp;
  tg.expand();

  const user = tg.initDataUnsafe.user || {};
  const userId = user.id;

  const balance = document.getElementById("balance");
  const balanceProfile = document.getElementById("balanceProfile");
  const deposit = document.getElementById("deposit");
  const openDaily = document.getElementById("openDaily");
  const connectWallet = document.getElementById("connectWallet");
  const openInventory = document.getElementById("openInventory");

  const btnHome = document.getElementById("btnHome");
  const btnProfile = document.getElementById("btnProfile");

  const subscribeModal = document.getElementById("subscribeModal");
  const subscribeBtn = document.getElementById("subscribeBtn");

  const caseModal = document.getElementById("caseModal");
  const closeCase = document.getElementById("closeCase");
  const openCaseBtn = document.getElementById("openCaseBtn");
  const resultText = document.getElementById("resultText");

  const inventoryModal = document.getElementById("inventoryModal");
  const closeInventory = document.getElementById("closeInventory");
  const inventoryList = document.getElementById("inventoryList");

  const API_URL = "https://kosmogift-worker.v-bot-2010.workers.dev";

  let balanceValue = 0;
  let walletAddress = null;
  let subscribed = false;

  // =======================
  // 1) ЗАГРУЗКА БАЛАНСА
  // =======================
  async function loadBalance() {
    try {
      const res = await fetch(API_URL + "/balance?user_id=" + userId);
      const data = await res.json();
      balanceValue = parseFloat(data.balance || 0);
      balance.innerText = balanceValue.toFixed(2) + " TON";
      balanceProfile.innerText = balanceValue.toFixed(2) + " TON";
    } catch (e) {
      console.log("Ошибка баланса", e);
    }
  }
  loadBalance();

  // =======================
  // 2) NAVIGATION
  // =======================
  btnHome.onclick = () => {
    document.getElementById("home").classList.add("active");
    document.getElementById("profile").classList.remove("active");
  };

  btnProfile.onclick = () => {
    document.getElementById("profile").classList.add("active");
    document.getElementById("home").classList.remove("active");
  };

  // =======================
  // 3) DEPOSIT
  // =======================
  deposit.addEventListener("click", async () => {
    const amount = parseFloat(prompt("Сколько TON пополнить? (мин. 0.1)"));

    if (!amount || isNaN(amount) || amount < 0.1) {
      return alert("Минимум 0.1 TON");
    }

    const paymentId = "pay_" + Date.now();

    // Ссылка на Tonkeeper
    const tonLink = `https://tonkeeper.com/transfer/UQAFXBXzBzau6ZCWzruiVrlTg3HAc8MF6gKIntqTLDifuWOi?amount=${amount}&text=${paymentId}`;

    tg.openUrl(tonLink);
    alert("Оплатите в Tonkeeper.");

    const interval = setInterval(async () => {
      const res = await fetch(API_URL + "/check-payment", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ payment_id: paymentId, amount })
      });

      const d = await res.json();

      if (d.ok) {
        clearInterval(interval);
        await loadBalance();
        alert("Пополнение успешно!");
      }
    }, 3000);
  });

  // =======================
  // 4) TONCONNECT
  // =======================
  connectWallet.addEventListener("click", async () => {
    const tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
      manifestUrl: "https://kosmogift.pages.dev/tonconnect-manifest.json"
    });

    try {
      const wallet = await tonConnectUI.connect();
      walletAddress = wallet.account.address;
      alert("Кошелёк подключён: " + walletAddress);
      connectWallet.style.display = "none";
      document.getElementById("disconnectWallet").style.display = "block";
    } catch (e) {
      alert("Подключение кошелька отменено");
    }
  });

  // =======================
  // 5) SUBSCRIBE (1 раз)
  // =======================
  function showSubscribe() {
    if (subscribed) return;
    subscribeModal.style.display = "flex";
  }

  subscribeBtn.addEventListener("click", () => {
    tg.openUrl("https://t.me/your_channel"); // <- Поставь свой канал
    subscribed = true;
    subscribeModal.style.display = "none";
  });

  // =======================
  // 6) DAILY CASE
  // =======================
  closeCase.addEventListener("click", () => {
    caseModal.style.display = "none";
  });

  openDaily.addEventListener("click", async () => {

    // Показываем подписку 1 раз
    showSubscribe();

    // Проверка "раз в 24 часа"
    const res = await fetch(API_URL + "/daily?user_id=" + userId);
    const d = await res.json();

    if (d.error === "already") {
      alert("Кейс можно открыть раз в 24 часа");
      return;
    }

    // Открываем окно кейса
    caseModal.style.display = "flex";
    resultText.innerText = "Нажми \"Открыть кейс\"";
  });

  openCaseBtn.addEventListener("click", async () => {

    // Шансы:
    // 0.01 - 90%
    // 0.02 - 5%
    // 0.03 - 2.5%
    // 0.04 - 1%
    // 0.05 - 0.75%
    // 0.06 - 0.5%
    // 0.07 - 0.24%
    // NFT lol pop - 0.01%

    const rnd = Math.random() * 100;

    let prize = null;

    if (rnd < 90) prize = { type: "ton", amount: 0.01 };
    else if (rnd < 95) prize = { type: "ton", amount: 0.02 };
    else if (rnd < 97.5) prize = { type: "ton", amount: 0.03 };
    else if (rnd < 98.5) prize = { type: "ton", amount: 0.04 };
    else if (rnd < 99.25) prize = { type: "ton", amount: 0.05 };
    else if (rnd < 99.75) prize = { type: "ton", amount: 0.06 };
    else if (rnd < 99.99) prize = { type: "ton", amount: 0.07 };
    else prize = { type: "nft", name: "lol pop" };

    // Если TON
    if (prize.type === "ton") {
      const add = await fetch(API_URL + "/add-ton", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ user_id: userId, amount: prize.amount })
      });

      const addRes = await add.json();
      await loadBalance();

      resultText.innerText = `Вы выиграли ${prize.amount} TON`;
    }

    // Если NFT
    if (prize.type === "nft") {
      await fetch(API_URL + "/add-nft", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ user_id: userId, nft: { name: prize.name } })
      });

      resultText.innerText = `Вы выиграли NFT: ${prize.name}`;
    }
  });

  // =======================
  // 7) INVENTORY
  // =======================
  closeInventory.addEventListener("click", () => {
    inventoryModal.style.display = "none";
  });

  openInventory.addEventListener("click", async () => {
    inventoryModal.style.display = "flex";

    const res = await fetch(API_URL + "/inventory?user_id=" + userId);
    const d = await res.json();

    inventoryList.innerHTML = "";

    d.inventory.forEach((item, idx) => {
      const el = document.createElement("div");
      el.className = "inventoryItem";

      el.innerHTML = `
        <div>${item.name || item.type}</div>
        <button data-idx="${idx}" class="sellBtn">Продать</button>
      `;

      inventoryList.appendChild(el);
    });

    // SELL buttons
    document.querySelectorAll(".sellBtn").forEach(btn => {
      btn.addEventListener("click", async () => {
        const idx = btn.getAttribute("data-idx");
        const item = d.inventory[idx];

        // Если NFT lol pop => цена 3.26
        const price = item.name === "lol pop" ? 3.26 : 0;

        await fetch(API_URL + "/sell-nft", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ user_id: userId, nft_name: item.name, price })
        });

        await loadBalance();
        alert("Продано!");
        openInventory.click(); // обновить инвентарь
      });
    });
  });

});
</script>

</body>
  </html>
