<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Gift Mini App</title>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>

  <link rel="stylesheet" href="style.css">
</head>
<body>

<!-- HOME -->
<div id="home" class="page active">
  <div class="top">
    <div class="userBar">
      <img id="avatar" class="avatar">
      <span id="balance">0.00 TON</span>
    </div>
  </div>

  <div class="caseBlock">
    <div class="caseIcon"></div>
    <div class="caseTitle">Daily Case</div>
    <button id="openDaily" class="caseBtn">Открыть кейс</button>
  </div>
</div>

<!-- PROFILE -->
<div id="profile" class="page">
  <div class="top">
    <div class="userBar">
      <img id="profileAvatar" class="avatar big">
      <span id="balanceProfile">0.00 TON</span>
    </div>
  </div>

  <div id="username"></div>

  <button id="connectWallet">Подключить кошелёк</button>
  <button id="disconnectWallet" style="display:none">Отключить кошелёк</button>
  <button id="deposit">Пополнить баланс</button>
  <button id="openInventory">Инвентарь</button>
</div>

<!-- SUBSCRIBE MODAL -->
<div id="subscribeModal" class="modal">
  <div class="subscribeContent">
    <div class="subscribeText">Для открытия кейса нужно подписаться на канал</div>
    <button id="subscribeBtn" class="caseBtn">Подписаться</button>
  </div>
</div>

<!-- CASE MODAL -->
<div id="caseModal" class="modal">
  <div class="caseModalContent">
    <div class="caseHeader">
      <div class="caseTitle">Daily Case</div>
      <button id="closeCase" class="closeBtn">✕</button>
    </div>

    <div class="stripWrap">
      <div id="strip" class="strip"></div>
      <div class="pointer"></div>
    </div>

    <div id="resultText" class="resultText">Нажми "Открыть кейс"</div>
    <button id="openCaseBtn" class="caseBtn">Открыть кейс</button>
  </div>
</div>

<!-- INVENTORY MODAL -->
<div id="inventoryModal" class="modal">
  <div class="inventoryContent">
    <button id="closeInventory" class="closeBtn">✕</button>
    <div id="inventoryList" class="inventoryList"></div>
  </div>
</div>

<div class="nav">
  <button id="btnHome">Главная</button>
  <button id="btnProfile">Профиль</button>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {

  if (!window.Telegram || !window.Telegram.WebApp) {
    alert("Mini App должен запускаться через Telegram!");
    return;
  }

  const tg = window.Telegram.WebApp;
  tg.expand();

  const user = tg.initDataUnsafe.user || {};
  const userId = user.id;

  const balance = document.getElementById("balance");
  const balanceProfile = document.getElementById("balanceProfile");
  const deposit = document.getElementById("deposit");
  const openDaily = document.getElementById("openDaily");
  const connectWallet = document.getElementById("connectWallet");
  const openInventory = document.getElementById("openInventory");

  const btnHome = document.getElementById("btnHome");
  const btnProfile = document.getElementById("btnProfile");

  const API_URL = "https://kosmogift-worker.v-bot-2010.workers.dev";

  let balanceValue = 0;

  async function loadBalance() {
    try {
      const res = await fetch(API_URL + "/balance?user_id=" + userId);
      const data = await res.json();
      balanceValue = parseFloat(data.balance || 0);
      balance.innerText = balanceValue.toFixed(2) + " TON";
      balanceProfile.innerText = balanceValue.toFixed(2) + " TON";
    } catch (e) {
      console.log("Ошибка баланса", e);
    }
  }

  loadBalance();

  // ---------- NAV ----------
  btnHome.onclick = () => {
    document.getElementById("home").classList.add("active");
    document.getElementById("profile").classList.remove("active");
  };

  btnProfile.onclick = () => {
    document.getElementById("profile").classList.add("active");
    document.getElementById("home").classList.remove("active");
  };

  // ---------- DEPOSIT ----------
  deposit.addEventListener("click", async () => {
    const amount = parseFloat(prompt("Сколько TON пополнить? (мин. 0.1)"));

    if (!amount || isNaN(amount) || amount < 0.1) {
      return alert("Минимум 0.1 TON");
    }

    const paymentId = "pay_" + Date.now();

    const nanotons = Math.floor(amount * 1e9);
    const tonLink = `ton://transfer/UQAFXBXzBzau6ZCWzruiVrlTg3HAc8MF6gKIntqTLDifuWOi?amount=${nanotons}&text=${paymentId}`;

    tg.openUrl(tonLink);
    alert("Оплатите в Tonkeeper.");

    const interval = setInterval(async () => {
      const res = await fetch(API_URL + "/check-payment", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ payment_id: paymentId, amount })
      });

      const d = await res.json();

      if (d.ok) {
        clearInterval(interval);
        await loadBalance();
        alert("Пополнение успешно!");
      }
    }, 3000);
  });

  // ---------- CONNECT WALLET ----------
  connectWallet.addEventListener("click", async () => {
    const tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
      manifestUrl: "https://kosmogift.pages.dev/tonconnect-manifest.json"
    });

    try {
      const wallet = await tonConnectUI.connect();
      alert("Кошелёк подключён: " + wallet.account.address);
    } catch (e) {
      alert("Подключение кошелька отменено");
    }
  });

  // ---------- OPEN DAILY ----------
  openDaily.addEventListener("click", async () => {
    alert("Открытие кейса пока не подключено");
  });

  // ---------- INVENTORY ----------
  openInventory.addEventListener("click", async () => {
    alert("Инвентарь пока не подключен");
  });

});
</script>

</body>
        </html>
